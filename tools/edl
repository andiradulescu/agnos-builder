#!/bin/bash
set -e

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null && pwd)"
ROOT=$DIR/../

# just a nice wrapper around the edl python tool

EDL_PATH=$DIR/edl_repo
VERSION="8573eba1b576305fec3a068393283143ffc34342"

if [ ! -d "$EDL_PATH" ]; then
  rm -rf $EDL_PATH
  git clone https://github.com/bkerler/edl $EDL_PATH
fi

pushd $EDL_PATH > /dev/null
python3 -m venv venv
source venv/bin/activate

if [ "$(< .git/HEAD)" != "$VERSION" ]; then
  echo "updating edl..."
  git fetch origin $VERSION
  git checkout $VERSION
  git submodule update --depth=1 --init --recursive

  # TODO: remove "--no-binary capstone" when capstone v5.0.2 is released
  # https://github.com/capstone-engine/capstone/issues/2301#issuecomment-2026835275
  pip3 install -r requirements.txt --no-binary capstone
fi
popd > /dev/null

if [[ "$(uname)" == 'Darwin' ]]; then
  ARCH=$(uname -m)

  # install brew if required
  if [[ $(command -v brew) == "" ]]; then
    echo "Installing Homebrew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    if [[ $SHELL == "/bin/zsh" ]]; then
      RC_FILE="$HOME/.zprofile"
    elif [[ $SHELL == "/bin/bash" ]]; then
      RC_FILE="$HOME/.bash_profile"
    fi
    # make brew available now
    if [[ $ARCH == "x86_64" ]]; then
      echo 'eval "$(/usr/local/bin/brew shellenv)"' >> $RC_FILE
      eval "$(/usr/local/bin/brew shellenv)"
    else
      echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $RC_FILE
      eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
  fi

  BREW_PREFIX=$(brew --prefix)

  # install libusb
  if [ ! -f $BREW_PREFIX/lib/libusb-1.0.0.dylib ]; then
    echo "Installing libusb"
    brew install libusb
    if [[ $ARCH == "arm64" ]]; then
      # https://github.com/pyusb/pyusb/issues/520
      # https://github.com/pyusb/pyusb/issues/355#issuecomment-974726078
      ln -s $BREW_PREFIX/lib/libusb-1.0.0.dylib /usr/local/lib/libusb.dylib
    fi
  fi
fi

$EDL_PATH/edl "$@"
